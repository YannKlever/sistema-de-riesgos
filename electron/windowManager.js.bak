const { BrowserWindow, dialog, app } = require('electron');
const path = require('path');
const ProductKeyService = require('./services/ProductKeyService');

// Importar configuraciones
const config = require('./config');

let mainWindow = null;
const productKeyService = new ProductKeyService();

function showMainWindow() {
    if (mainWindow && !mainWindow.isDestroyed()) {
        if (mainWindow.isMinimized()) mainWindow.restore();
        mainWindow.show();
        mainWindow.focus();
    }
}

function createMainWindow() {
    mainWindow = new BrowserWindow({
        width: 1200,
        height: 800,
        minWidth: 800,
        minHeight: 600,
        show: false,
        backgroundColor: '#f5f5f5',
        title: 'Sistema de Gestión de Riesgos',
        webPreferences: {
            contextIsolation: true,
            nodeIntegration: false,
            enableRemoteModule: false,
            preload: path.join(__dirname, 'preload.js'),
            webSecurity: true,
            allowRunningInsecureContent: false,
            experimentalFeatures: false,
            nodeIntegrationInWorker: false,
            nodeIntegrationInSubFrames: false,
            devTools: false
        },
        titleBarStyle: 'default',
        autoHideMenuBar: true,
        menu: null,
        frame: true
    });

    // ELIMINADO: console-message handler

    // Optimizar rendimiento
    mainWindow.webContents.setWindowOpenHandler(() => ({ action: 'deny' }));

    mainWindow.webContents.on('will-navigate', (event, navigationUrl) => {
        // En producción, permitir solo file protocol
        if (config.isProduction && !navigationUrl.startsWith('file://')) {
            event.preventDefault();
        }

        // En desarrollo, permitir solo localhost
        if (!config.isProduction && !navigationUrl.startsWith('http://localhost:3000')) {
            event.preventDefault();
        }
    });

    // Evento cuando el contenido esté completamente cargado
    mainWindow.webContents.on('did-finish-load', () => {
        if (mainWindow && !mainWindow.isDestroyed()) {
            setTimeout(() => {
                mainWindow.show();
                mainWindow.focus();

                // Iniciar verificación periódica
                try {
                    productKeyService.startPeriodicVerification();
                } catch (error) {
                    // Silenciar error
                }
            }, 100);
        }
    });

    // Manejar errores de carga
    mainWindow.webContents.on('did-fail-load', (event, errorCode, errorDescription, validatedURL) => {
        if (mainWindow && !mainWindow.isDestroyed()) {
            dialog.showMessageBox(mainWindow, {
                type: 'error',
                title: 'Error de Carga',
                message: 'No se pudo cargar la aplicación',
                detail: `Error ${errorCode}: ${errorDescription}`
            }).catch(() => { }); // Silenciar error
        }

        // Reintentar después de 5 segundos solo en desarrollo
        if (!config.isProduction) {
            setTimeout(() => {
                if (mainWindow && !mainWindow.isDestroyed()) {
                    loadApp();
                }
            }, 5000);
        }
    });

    // Prevenir cambios de título
    mainWindow.on('page-title-updated', (e) => {
        e.preventDefault();
    });

    // Cargar la aplicación
    loadApp();

    // Manejar eventos de la ventana
    mainWindow.on('closed', () => {
        try {
            productKeyService.stopPeriodicVerification();
        } catch (error) {
            // Silenciar error
        }
        mainWindow = null;
    });

    mainWindow.on('close', (event) => {
        // En macOS, permitir el cierre normal
        // En Windows/Linux, la aplicación se cerrará con window-all-closed
        // No prevenir el evento - dejar que la ventana se cierre normalmente

        // Solo asegurar que los recursos se liberen
        try {
            productKeyService.stopPeriodicVerification();
        } catch (error) {
            // Silenciar error
        }

        // NO llamar a event.preventDefault() - esto permite el cierre normal
    });

    return mainWindow;
}

function loadApp() {
    try {
        if (config.isProduction) {
            const buildPath = path.join(process.resourcesPath, 'frontend-build', 'index.html');

            if (require('fs').existsSync(buildPath)) {
                // Para HashRouter, necesitamos cargar con #/ para la ruta inicial
                const appUrl = `file://${buildPath}#/login`;
                mainWindow.loadURL(appUrl);
            } else {
                throw new Error(`No se pudo encontrar: ${buildPath}`);
            }
        } else {
            // En desarrollo
            mainWindow.loadURL('http://localhost:3000/#/login');
        }
    } catch (error) {
        handleLoadError(error);
    }
}

function handleLoadError(error) {
    if (mainWindow && !mainWindow.isDestroyed()) {
        dialog.showMessageBox(mainWindow, {
            type: 'error',
            title: 'Error de Carga',
            message: 'No se pudo cargar la aplicación',
            detail: config.isProduction
                ? `Error: ${error.message}\n\nVerifique que los archivos de la aplicación estén completos.`
                : `Error: ${error.message}\n\nVerifique que el servidor de desarrollo de React esté ejecutándose en puerto 3000.`
        }).catch(() => { }); // Silenciar error
    }
}

// Función para verificar la clave al inicio
async function verifyProductKeyOnStart() {
    try {
        await productKeyService.init();
        const isValid = await productKeyService.isKeyValidated();
        return { isValid };
    } catch (error) {
        return { isValid: false, error: error.message };
    }
}

// Manejar clave expirada
async function handleProductKeyExpired() {
    if (mainWindow && !mainWindow.isDestroyed()) {
        mainWindow.hide();
    }

    try {
        const result = await dialog.showMessageBox({
            type: 'warning',
            buttons: ['Reactivar', 'Salir'],
            title: 'Licencia Expirada',
            message: 'Su licencia ha expirado o ha sido desactivada.',
            detail: 'Debe reactivar el producto para continuar.'
        });

        if (result.response === 0) {
            await productKeyService.clearProductKey();
            if (mainWindow && !mainWindow.isDestroyed()) {
                mainWindow.close();
            }
            return { action: 'reactivate' };
        } else {
            return { action: 'quit' };
        }
    } catch (error) {
        return { action: 'quit' };
    }
}

// Función para obtener la ventana principal
function getMainWindow() {
    return mainWindow;
}

// Función para verificar si la ventana existe
function hasMainWindow() {
    return mainWindow && !mainWindow.isDestroyed();
}

// Función para recargar la ventana
function reloadMainWindow() {
    if (mainWindow && !mainWindow.isDestroyed()) {
        mainWindow.reload();
    }
}

module.exports = {
    createMainWindow,
    getMainWindow,
    hasMainWindow,
    verifyProductKeyOnStart,
    handleProductKeyExpired,
    reloadMainWindow,
    showMainWindow,
    checkProductKeyStatus: () => productKeyService.isKeyValidated(),
    getProductKeyInfo: () => productKeyService.getStoredKeyInfo(),
    clearProductKey: () => productKeyService.clearProductKey()
};